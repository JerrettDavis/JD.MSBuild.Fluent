<Project>

  <PropertyGroup>
    <!-- Enable/disable generation (default: true) -->
    <JDMSBuildFluentGenerateEnabled Condition="'$(JDMSBuildFluentGenerateEnabled)' == ''">true</JDMSBuildFluentGenerateEnabled>
    
    <!-- Factory type (auto-detected if blank) -->
    <JDMSBuildFluentDefinitionType Condition="'$(JDMSBuildFluentDefinitionType)' == ''"></JDMSBuildFluentDefinitionType>
    
    <!-- Factory method name (default: Create) -->
    <JDMSBuildFluentDefinitionMethod Condition="'$(JDMSBuildFluentDefinitionMethod)' == ''">Create</JDMSBuildFluentDefinitionMethod>
    
    <!-- Auto-detect factory type if not specified -->
    <JDMSBuildFluentAutoDetect Condition="'$(JDMSBuildFluentAutoDetect)' == '' and '$(JDMSBuildFluentDefinitionType)' == ''">true</JDMSBuildFluentAutoDetect>
  </PropertyGroup>

  <!--
    Determine the correct task assembly path based on MSBuild runtime and version.
    
    The task assembly is multi-targeted:
    - net472: For .NET Framework MSBuild
    - net8.0/net9.0/net10.0: For .NET Core MSBuild (version-matched)
  -->
  <PropertyGroup>
    <!-- Select task assembly based on MSBuild version -->
    <_JDMSBuildFluentTasksFolder Condition="'$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '18.0'))">net10.0</_JDMSBuildFluentTasksFolder>
    <_JDMSBuildFluentTasksFolder Condition="'$(_JDMSBuildFluentTasksFolder)' == '' and '$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '17.14'))">net10.0</_JDMSBuildFluentTasksFolder>
    <_JDMSBuildFluentTasksFolder Condition="'$(_JDMSBuildFluentTasksFolder)' == '' and '$(MSBuildRuntimeType)' == 'Core' and $([MSBuild]::VersionGreaterThanOrEquals('$(MSBuildVersion)', '17.12'))">net9.0</_JDMSBuildFluentTasksFolder>
    <_JDMSBuildFluentTasksFolder Condition="'$(_JDMSBuildFluentTasksFolder)' == '' and '$(MSBuildRuntimeType)' == 'Core'">net8.0</_JDMSBuildFluentTasksFolder>
    <_JDMSBuildFluentTasksFolder Condition="'$(_JDMSBuildFluentTasksFolder)' == ''">net472</_JDMSBuildFluentTasksFolder>

    <_JDMSBuildFluentTaskAssembly>$(MSBuildThisFileDirectory)..\tasks\$(_JDMSBuildFluentTasksFolder)\JD.MSBuild.Fluent.Tasks.dll</_JDMSBuildFluentTaskAssembly>
  </PropertyGroup>

  <!-- Register MSBuild task -->
  <UsingTask TaskName="JD.MSBuild.Fluent.Tasks.GenerateMSBuildAssets"
             AssemblyFile="$(_JDMSBuildFluentTaskAssembly)" />

  <!-- 
    Generate MSBuild assets after compilation using native task.
    
    CRITICAL: Only runs for projects that DIRECTLY reference JD.MSBuild.Fluent as a PackageReference.
    Transitive consumers (projects that reference projects using JD.MSBuild.Fluent) will NOT trigger generation.
    They will simply consume the generated MSBuild files like any normal .props/.targets package.
  -->
  <Target Name="JDMSBuildFluentGenerate" 
          AfterTargets="AfterBuild" 
          BeforeTargets="PrepareForPublish;GenerateNuspec;_GetPackageFiles"
          Condition="'$(_JDMSBuildFluentDirectReference)' == 'true' and '$(JDMSBuildFluentGenerateEnabled)' == 'true' and '$(TargetFramework)' != '' and Exists('$(TargetPath)')">
    
    <PropertyGroup>
      <_JDMSBuildFluentAssembly>$(TargetPath)</_JDMSBuildFluentAssembly>
      <_JDMSBuildFluentTempOutput>$(MSBuildProjectDirectory)\obj\msbuild_fluent_generated</_JDMSBuildFluentTempOutput>
      <_JDMSBuildFluentOutput>$(MSBuildProjectDirectory)</_JDMSBuildFluentOutput>
      
      <!-- Auto-detect factory type -->
      <_JDMSBuildFluentType Condition="'$(JDMSBuildFluentDefinitionType)' != ''">$(JDMSBuildFluentDefinitionType)</_JDMSBuildFluentType>
      <_JDMSBuildFluentType Condition="'$(_JDMSBuildFluentType)' == '' and '$(JDMSBuildFluentAutoDetect)' == 'true'">$(RootNamespace).DefinitionFactory</_JDMSBuildFluentType>
      <_JDMSBuildFluentType Condition="'$(_JDMSBuildFluentType)' == '' and '$(JDMSBuildFluentAutoDetect)' == 'true' and '$(RootNamespace)' == ''">$(AssemblyName).DefinitionFactory</_JDMSBuildFluentType>
    </PropertyGroup>
    
    <!-- Skip if no type specified -->
    <Warning Text="JD.MSBuild.Fluent: No definition type specified. Set JDMSBuildFluentDefinitionType property or ensure $(RootNamespace).DefinitionFactory exists."
             Condition="'$(_JDMSBuildFluentType)' == ''" />
    
    <!-- Generate MSBuild assets using native task -->
    <Message Text="JD.MSBuild.Fluent: Generating MSBuild assets from $(_JDMSBuildFluentType).$(JDMSBuildFluentDefinitionMethod)()..." 
             Importance="High"
             Condition="'$(_JDMSBuildFluentType)' != ''" />
    
    <GenerateMSBuildAssets AssemblyFile="$(_JDMSBuildFluentAssembly)"
                           FactoryType="$(_JDMSBuildFluentType)"
                           FactoryMethod="$(JDMSBuildFluentDefinitionMethod)"
                           OutputPath="$(_JDMSBuildFluentTempOutput)"
                           Condition="'$(_JDMSBuildFluentType)' != ''">
      <Output TaskParameter="GeneratedFiles" ItemName="_JDMSBuildFluentGeneratedFiles" />
    </GenerateMSBuildAssets>
    
    <!-- Copy entire generated directory structure -->
    <ItemGroup>
      <_TempGeneratedFiles Include="$(_JDMSBuildFluentTempOutput)\**\*.props" />
      <_TempGeneratedFiles Include="$(_JDMSBuildFluentTempOutput)\**\*.targets" />
    </ItemGroup>
    
    <Copy SourceFiles="@(_TempGeneratedFiles)" 
          DestinationFiles="@(_TempGeneratedFiles->'$(_JDMSBuildFluentOutput)\%(RecursiveDir)%(Filename)%(Extension)')" 
          SkipUnchangedFiles="true"
          Condition="'@(_TempGeneratedFiles)' != ''" />
    
    <!-- Add generated files to Content for IDE visibility -->
    <ItemGroup Condition="'@(_TempGeneratedFiles)' != ''">
      <Content Include="$(_JDMSBuildFluentOutput)\**\*.props"
               Exclude="$(_JDMSBuildFluentOutput)\obj\**;$(_JDMSBuildFluentOutput)\bin\**"
               Visible="false" 
               CopyToOutputDirectory="Never" />
      <Content Include="$(_JDMSBuildFluentOutput)\**\*.targets"
               Exclude="$(_JDMSBuildFluentOutput)\obj\**;$(_JDMSBuildFluentOutput)\bin\**"
               Visible="false" 
               CopyToOutputDirectory="Never" />
    </ItemGroup>
    
    <!-- Clean up temp directory -->
    <RemoveDir Directories="$(_JDMSBuildFluentTempOutput)" Condition="'$(_JDMSBuildFluentType)' != ''" />
    
    <Message Text="JD.MSBuild.Fluent: Generated @(_JDMSBuildFluentGeneratedFiles->Count()) file(s)" 
             Importance="High"
             Condition="'@(_JDMSBuildFluentGeneratedFiles)' != ''" />
  </Target>
</Project>